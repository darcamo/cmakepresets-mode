# cmakepresets-mode

A major mode for editing CMake presets files.

`cmakepresets-mode` is built on top of `json-ts-mode`, since CMake presets are JSON files. This mode only adds a few minor improvements to the editing experience by providing additional conveniences tailored specifically for CMake presets.

Currently, the mode adds support for `imenu` to improve navigation within the CMake presets files, and adds completions for some macro expansions, such as `${<cursor-here>}` or `$env{<cursor-here>}`.

**Note:** If you have a language server setup for JSON that provides the `documentSymbolProvider` capability, it will be used to provide the `imenu` entries instead. You can disable that capability in the language server (while keeping all other functionality) to benefit from the `imenu` generated by `cmakepresets-mode`.

## Configuration

Configuring `cmakepresets-mode` is simple; just install the package and ensure the mode is enabled for CMake preset files. The mode automatically adds entries to `auto-mode-alist` for `"CMakePresets.json"` and `"CMakeUserPresets.json"` files. However, this may not work reliably due to potential conflicts with the `json-mode` package, which can take precedence. To ensure proper setup, you can use the following function in your configuration:

```emacs-lisp
(defun is-cmake-presets-file? ()
  "Check if FILENAME is the name of a cmake presets file."
  (if-let* ((buffer-name (buffer-file-name))
            (filename (file-name-nondirectory buffer-name)))
            ;;               Add other files if you need
      (if (member filename '("CMakePresets.json" "CMakeUserPresets.json")) t nil)))
```

Then, add the following lambda to the `json-mode-hook` to activate `cmakepresets-mode` for matching files:

```emacs-lisp
(lambda () (when (is-cmake-presets-file?) (cmakepresets-mode)))
```

If you don't have `json-mode` installed, then openning a file named "CMakePresets.json" or "CMakeUserPresets.json" should already use `cmakepresets-mode`, but you can always add more entries to `auto-mode-alist` to use it automatically.

Below is a complete configuration example (with `use-package` and elpaca), including some additional functionalities that you can adapt to fit your specific use case.

```emacs-lisp
(use-package cmakepresets-mode
  :ensure (cmakepresets-mode :type git :host github :protocol ssh
                             :repo "darcamo/cmakepresets-mode" :depth nil)
  :mode
  ;; Add a custom json file to use cmakepresets-mode
  ("ConanPresets\\.json" . cmakepresets-mode)
  
  :config
  ;; Setup a language server for JSON
  (add-to-list 'eglot-server-programs
               '((cmakepresets-mode)
                 . ("vscode-json-languageserver" "--stdio")))

  :hook
  ;; You don't need this if json-mode is not installed
  (json-mode . (lambda () (when (is-cmake-presets-file?) (cmakepresets-mode))))
  
  ;; Disable only the "documentSymbolProvider" capability to avoid it being used to generate imenu
  (cmakepresets-mode . (lambda () (set
                              (make-local-variable 'eglot-ignored-server-capabilities)
                              '(:documentSymbolProvider))))
  )
```
